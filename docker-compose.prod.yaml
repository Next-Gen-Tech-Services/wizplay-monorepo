# Production Docker Compose Configuration
# Uses universal .env.production file from root directory

services:
  # Databases
  user_db_server:
    image: "postgres:15-alpine"
    container_name: user_db_server
    ports:
      - "5436:5432"
    environment:
      POSTGRES_USER: ${USER_DB_USER:-user_db}
      POSTGRES_PASSWORD: ${USER_DB_PASSWORD:-user_db}
      POSTGRES_DB: user_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - user_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER_DB_USER:-user_db} -d user_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth_db_server:
    image: "postgres:15-alpine"
    container_name: auth_db_server
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: ${AUTH_DB_USER:-auth_db}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-auth_db}
      POSTGRES_DB: auth_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - auth_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER:-auth_db} -d auth_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  match_db_server:
    image: "postgres:15-alpine"
    container_name: match_db_server
    ports:
      - "5435:5432"
    environment:
      POSTGRES_USER: ${MATCH_DB_USER:-match_db}
      POSTGRES_PASSWORD: ${MATCH_DB_PASSWORD:-match_db}
      POSTGRES_DB: match_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - match_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${MATCH_DB_USER:-match_db} -d match_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  coupon_db_server:
    image: "postgres:15-alpine"
    container_name: coupon_db_server
    ports:
      - "5437:5432"
    environment:
      POSTGRES_USER: ${COUPON_DB_USER:-coupon_db}
      POSTGRES_PASSWORD: ${COUPON_DB_PASSWORD:-coupon_db}
      POSTGRES_DB: coupon_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - coupon_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${COUPON_DB_USER:-coupon_db} -d coupon_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  contest_db_server:
    image: "postgres:15-alpine"
    container_name: contest_db_server
    ports:
      - "5438:5432"
    environment:
      POSTGRES_USER: ${CONTEST_DB_USER:-contest_db}
      POSTGRES_PASSWORD: ${CONTEST_DB_PASSWORD:-contest_db}
      POSTGRES_DB: contest_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - contest_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CONTEST_DB_USER:-contest_db} -d contest_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  wallet_db_server:
    image: "postgres:15-alpine"
    container_name: wallet_db_server
    ports:
      - "5439:5432"
    environment:
      POSTGRES_USER: ${WALLET_DB_USER:-wallet_db}
      POSTGRES_PASSWORD: ${WALLET_DB_PASSWORD:-wallet_db}
      POSTGRES_DB: wallet_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - wallet_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${WALLET_DB_USER:-wallet_db} -d wallet_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification_db_server:
    image: "postgres:15-alpine"
    container_name: notification_db_server
    ports:
      - "5440:5432"
    environment:
      POSTGRES_USER: ${NOTIFICATION_DB_USER:-notification_db}
      POSTGRES_PASSWORD: ${NOTIFICATION_DB_PASSWORD:-notification_db}
      POSTGRES_DB: notification_service
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - notification_db_data:/var/lib/postgresql/data
      - ./database/init/:/docker-entrypoint-initdb.d/
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NOTIFICATION_DB_USER:-notification_db} -d notification_service"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zookeeper for Kafka (Confluent)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc -w 2 localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka (Confluent single-broker for production)
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,INTERNAL://kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,INTERNAL://0.0.0.0:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'false'
      KAFKA_LOG_DIRS: /var/lib/kafka/data
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - app-network
    restart: unless-stopped
    user: root
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Redis for caching/sessions
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Microservices
  auth_service:
    build:
      context: .
      dockerfile: apps/auth_service/dockerfile.prod
    container_name: auth_service
    ports:
      - "4001:4001"
    environment:
      NODE_ENV: production
      PORT: 4001
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      auth_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4001/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  user_service:
    build:
      context: .
      dockerfile: apps/user_service/dockerfile.prod
    container_name: user_service
    ports:
      - "4002:4002"
    environment:
      NODE_ENV: production
      PORT: 4002
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      user_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4002/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  match_service:
    build:
      context: .
      dockerfile: apps/match_service/dockerfile.prod
    container_name: match_service
    ports:
      - "4003:4003"
    environment:
      NODE_ENV: production
      PORT: 4003
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      match_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4003/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  coupon_service:
    build:
      context: .
      dockerfile: apps/coupon_service/dockerfile.prod
    container_name: coupon_service
    ports:
      - "4004:4004"
    environment:
      NODE_ENV: production
      PORT: 4004
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      coupon_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4004/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  contest_service:
    build:
      context: .
      dockerfile: apps/contest_service/dockerfile.prod
    container_name: contest_service
    ports:
      - "4005:4005"
    environment:
      NODE_ENV: production
      PORT: 4005
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      contest_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4005/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  wallet_service:
    build:
      context: .
      dockerfile: apps/wallet_service/dockerfile.prod
    container_name: wallet_service
    ports:
      - "4006:4006"
    environment:
      NODE_ENV: production
      PORT: 4006
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      wallet_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4006/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  notification_service:
    build:
      context: .
      dockerfile: apps/notification_service/dockerfile.prod
    container_name: notification_service
    ports:
      - "4007:4007"
    environment:
      NODE_ENV: production
      PORT: 4007
      REDIS_HOST: redis
      NOTIFICATION_DATABASE_HOST: notification_db_server
    env_file:
      - .env.production
    depends_on:
      notification_db_server:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4007/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  gateway_service:
    build:
      context: .
      dockerfile: apps/gateway_service/dockerfile.prod
    container_name: gateway_service
    ports:
      - "8000:8000"
    environment:
      NODE_ENV: production
      PORT: 8000
      AUTH_SERVICE_URL: http://auth_service:4001
      USER_SERVICE_URL: http://user_service:4002
      MATCHES_SERVICE_URL: http://match_service:4003
      COUPONS_SERVICE_URL: http://coupon_service:4004
      CONTEST_SERVICE_URL: http://contest_service:4005
      WALLET_SERVICE_URL: http://wallet_service:4006
      NOTIFICATION_SERVICE_URL: http://notification_service:4007
    env_file:
      - .env.production
    depends_on:
      auth_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
      match_service:
        condition: service_healthy
      coupon_service:
        condition: service_healthy
      contest_service:
        condition: service_healthy
      wallet_service:
        condition: service_healthy
      notification_service:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-network:
    driver: bridge

volumes:
  kafka_data:
    driver: local
  user_db_data:
    driver: local
  auth_db_data:
    driver: local
  match_db_data:
    driver: local
  coupon_db_data:
    driver: local
  contest_db_data:
    driver: local
  wallet_db_data:
    driver: local
  notification_db_data:
    driver: local
  zookeeper_data:
    driver: local
  redis_data:
    driver: local
