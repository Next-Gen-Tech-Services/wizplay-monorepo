# Production Docker Compose Configuration
# Uses universal .env.production file from root directory
# Database connections are configured via RDS in .env.production

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc -w 2 localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Kafka (Confluent single-broker for production)
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,EXTERNAL://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - app-network
    restart: unless-stopped
    user: root
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 90s

  # Redis for caching/sessions
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Microservices
  auth_service:
    build:
      context: .
      dockerfile: apps/auth_service/dockerfile.prod
    container_name: auth_service
    ports:
      - "4001:4001"
    environment:
      NODE_ENV: production
      PORT: 4001
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4001/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  user_service:
    build:
      context: .
      dockerfile: apps/user_service/dockerfile.prod
    container_name: user_service
    ports:
      - "4002:4002"
    environment:
      NODE_ENV: production
      PORT: 4002
      REDIS_HOST: redis
    env_file:
      - .env.production
    volumes:
      - user_banners:/app/public/banners
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4002/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  match_service:
    build:
      context: .
      dockerfile: apps/match_service/dockerfile.prod
    container_name: match_service
    ports:
      - "4003:4003"
    environment:
      NODE_ENV: production
      PORT: 4003
      REDIS_HOST: redis
    env_file:
      - .env.production
    volumes:
      - match_flags:/app/public/flags
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4003/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  coupon_service:
    build:
      context: .
      dockerfile: apps/coupon_service/dockerfile.prod
    container_name: coupon_service
    ports:
      - "4004:4004"
    environment:
      NODE_ENV: production
      PORT: 4004
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4004/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  contest_service:
    build:
      context: .
      dockerfile: apps/contest_service/dockerfile.prod
    container_name: contest_service
    ports:
      - "4005:4005"
    environment:
      NODE_ENV: production
      PORT: 4005
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4005/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  wallet_service:
    build:
      context: .
      dockerfile: apps/wallet_service/dockerfile.prod
    container_name: wallet_service
    ports:
      - "4006:4006"
    environment:
      NODE_ENV: production
      PORT: 4006
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4006/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  notification_service:
    build:
      context: .
      dockerfile: apps/notification_service/dockerfile.prod
    container_name: notification_service
    ports:
      - "4007:4007"
    environment:
      NODE_ENV: production
      PORT: 4007
      REDIS_HOST: redis
    env_file:
      - .env.production
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4007/api/v1/health-check"]
      interval: 30s
      timeout: 10s
      retries: 3

  gateway_service:
    build:
      context: .
      dockerfile: apps/gateway_service/dockerfile.prod
    container_name: gateway_service
    ports:
      - "8000:8000"
    environment:
      NODE_ENV: production
      PORT: 8000
      AUTH_SERVICE_URL: http://auth_service:4001
      USER_SERVICE_URL: http://user_service:4002
      MATCHES_SERVICE_URL: http://match_service:4003
      COUPONS_SERVICE_URL: http://coupon_service:4004
      CONTEST_SERVICE_URL: http://contest_service:4005
      WALLET_SERVICE_URL: http://wallet_service:4006
      NOTIFICATION_SERVICE_URL: http://notification_service:4007
    env_file:
      - .env.production
    depends_on:
      auth_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
      match_service:
        condition: service_healthy
      coupon_service:
        condition: service_healthy
      contest_service:
        condition: service_healthy
      wallet_service:
        condition: service_healthy
      notification_service:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-network:
    driver: bridge

volumes:
  kafka_data:
    driver: local
  zookeeper_data:
    driver: local
  redis_data:
    driver: local
  match_flags:
    driver: local
  user_banners:
    driver: local
